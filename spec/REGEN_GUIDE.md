# Fixture Regeneration Guide

This guide defines deterministic regeneration for strict-schema fixtures and goldens.

## Principles

- Never hand-edit expected JSON outputs or golden fixture bytes.
- Always regenerate fixtures from tool output and deterministic commands.
- Regeneration is allowed during draft/pre-release. See [docs/DRAFT_POLICY.md](./DRAFT_POLICY.md).

## A) Regenerate CI expected `run-vectors` fixture

Run from repo root:

```bash
cargo run -p rulia-cli --bin portable-workflow -- run-vectors --vectors crates/rulia-cli/tests/fixtures/vectorset_v0_ci_all_pass.json --levels L0,L1,L2,L3,L4 --normalize ci-v0 > crates/rulia-cli/tests/fixtures/ci_gate_expected_run_vectors_ci_v0.json
```

Regenerate the L2 artifact-pipeline migration golden (expression/native-branch/import-recursion coverage):

```bash
cargo run -p rulia-cli --bin portable-workflow -- run-vectors --vectorset crates/rulia-cli/tests/fixtures/vectorset_v0_run_vectors_l2_artifact_pipeline.json --levels L2 > crates/rulia-cli/tests/fixtures/run_vectors_l2_artifact_pipeline_expected.json
```

## B) Regenerate `.rulia.bin` fixtures from `.rjl` sources

Template:

```bash
cargo run -p rulia-cli --bin rulia -- encode <src> > <dst>
```

Current repo-backed `.rjl -> .rulia.bin` fixture set (`workflow_artifact_v0_subset`):

```bash
for src in crates/rulia-cli/tests/fixtures/workflow_artifact_v0_subset/*.rjl; do
  dst="${src%.rjl}.rulia.bin"
  cargo run -p rulia-cli --bin rulia -- encode "$src" > "$dst"
done
```

Note: The canonical extension is `.rjl`. Use `.rjl` for all new fixtures.

Note: import-recursive fixtures under
`crates/rulia-cli/tests/fixtures/workflow_artifact_v0_subset/import_recursive_expression/`
are text entrypoints/import leaves only and intentionally do not have checked-in `.rulia.bin` siblings.

Note: there are currently no checked-in direct `.json -> .rulia.bin` sibling fixture pairs in this repo.

## C) Regenerate bundle fixtures (manifest + artifact bytes), where applicable

Bundle files are under `crates/rulia-cli/tests/fixtures/**/bundle*/`.

### C1. Artifact bytes

If the artifact source is `.rjl`, regenerate artifact bytes with:

```bash
cargo run -p rulia-cli --bin rulia -- encode <artifact_src.rjl> > <bundle_dir>/artifact/ir.rulia.bin
```

For byte-oriented bundle fixtures (for example `bundle_minimal_v0`), regenerate deterministic artifact bytes directly:

```bash
printf 'bundle-valid-artifact\n' > crates/rulia-cli/tests/fixtures/bundle_minimal_v0/valid_bundle/artifact/ir.rulia.bin
printf 'bundle-mismatch-artifact\n' > crates/rulia-cli/tests/fixtures/bundle_minimal_v0/hash_mismatch/artifact/ir.rulia.bin
```

### C2. Manifest bytes (`manifest.rulia.bin`)

Template (manifest source text must contain the correct digest(s) for referenced artifact bytes):

```bash
cargo run -p rulia-cli --bin rulia -- encode <bundle_manifest_src.rjl> > <bundle_dir>/manifest.rulia.bin
```

Helpful digest command while updating manifest source:

```bash
shasum -a 256 <bundle_dir>/artifact/ir.rulia.bin
```

## FFI Meta Round-Trip Fixtures

- `crates/rulia-ffi/tests/ffi_portable_workflow_meta_roundtrip.rs` currently uses in-test generated bytes (no checked-in fixture files to regenerate).
- If file-backed fixtures are added later, regenerate them using the same canonical `rulia encode` flow above and keep them tool-generated only.

## What To Check After Regen

Run from repo root:

```bash
cargo test --workspace
```

CI gate golden/parity checks to verify explicitly:

```bash
cargo test -p rulia-cli --test portable_workflow_cli run_vectors_ci_v0_normalized_golden_json_is_deterministic
cargo test -p rulia-ffi --test ffi_frozen_verb_parity
```

Also ensure your CI gate job passes before merge.

## Guardrail References

- Draft policy: `docs/DRAFT_POLICY.md`
- CI expected run-vectors golden guardrail: `crates/rulia-cli/tests/portable_workflow_cli.rs`
- Frozen verb parity guardrail: `crates/rulia-ffi/tests/ffi_frozen_verb_parity.rs`
- FFI meta round-trip guardrail: `crates/rulia-ffi/tests/ffi_portable_workflow_meta_roundtrip.rs`
